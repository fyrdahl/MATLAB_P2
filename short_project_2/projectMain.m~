%% ONBI short project 2 - Magnetic Resonance Fingerprinting
% Supervisor: 

clear all
close all
addpath(genpath('/Applications/fsl/'))
addpath(genpath('/usr/local/fsl'))
addpath(genpath('/usr/local/fsl/bin'))
addpath(genpath('/Users/jallen/Documents/MATLAB/short_project_2'))

%%

%which phantom is the data from? ('sphereD170' or 'Jack'?)
phantomName = 'sphereD170';

% Choose the offset list to use. List 2 is the original 'random' list of
% offsets. Lists 3:8 are variations on List2, as described below.
%
% 3: 1st TR offset = 10000
% 4: flip Angles = 90 and 180
% 5: TE offset = 20
% 6: TR offset = 1500, TE offset = 20, FA1 = 90
% 7: TR offset = 1500, TE offset = 20
% 8: TR offset = 15000
offsetListNum = 3;

[TEImageInfo, TIImageInfo, FPImageInfo, TEimages, TIimages, FPimages, TE, TI] = readData(phantomName, offsetListNum);
%%
[SNR signal background] = calcSNR(TEimages,TE,'showFigure');
%%
run('compartmentSignals.m')
%%
% mask including whole phantom
load('/Users/jallen/Documents/MATLAB/short_project_2/mask.mat')
run('visualiseImages.m')

%% normalise pixel values
% TEimages(:,:,TE) = TEimages(:,:,TE)/max(max(max(TEimages(:,:,:))));
% TIimages(:,:,TE) = TIimages(:,:,TI)/max(max(max(TIimages(:,:,:))));

%% Calculate T1 and T2

[compartmentT1s, compartmentT2s, fittedCurve, goodness, output] = fitEvolutionCurves(TEimages, TIimages, TE(2:end)', TI(2:end)', 'compartments', compartmentCenters);

% run('calcT1T2withMeans.m')

%%
run('readFingerprintOffsetList.m')
fingerprintLists(:,:,offsetListNum)
%% simulate magnetisation evolution
%check bloch simulation by using properties of the phantom

% sphereD170 properties
T1 = 282.5;
T2 = 214.1;

freqOffset = 0;
[simMtransverse, simImageMtransverse, M, Mxy,flipAngles] = SimBloch(T1, T2, fingerprintLists(:,:,offsetListNum), 'showPlot',freqOffset);

run('plotSim.m')

run('calcSimilarity.m')

run('compileDictionary.m')




